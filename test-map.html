<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js and the geo projection plugin -->
<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<!-- Load Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>

<!-- Create an element where the map will take place -->
<div id="mapid"></div>

<style>
#mapid { height: 800px; width: 800px }
</style>
<body>
   
<script>


// mapid is the id of the div where the map will appear
var map = L
  .map('mapid')
  .setView([34.45,-119.7], 12);   // center position + zoom

// Add a tile to the map = a background. Comes from OpenStreetmap
L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
    maxZoom: 18,
    }).addTo(map);

// Add a svg layer to the map
L.svg().addTo(map);




var data = d3.json("yelp_filtered_to_santa_barbara.json").then(function(data){
  
  //initialize the marker
  var markers = [];
  //iterate through the entire json file and append the long and lat with appropriate format
  for(let i = 0; i < data.length; i++){
    markers.push({
      long: data[i].longitude,
      lat: data[i].latitude,
      review_count: data[i].review_count 
    })
  }

  // Select the svg area and add circles:
  d3.select("#mapid")
    .select("svg")
    .selectAll("myCircles")
    .data(markers)
    .enter()
    .append("circle")
      .attr("cx", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).x })
      .attr("cy", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).y })
      .attr("r", function(d){return d.review_count/50}) //Reviwe_count cannot scale correctly with circle size. 1. logrithmetic scale (linear spacing ish approach) 2. just divide and get the extreme
      //.attr("r", function(d){return Math.log(d.review_count)*5})
      .style("fill", "red")
      .attr("stroke", "red")
      .attr("stroke-width", 3)
      .attr("fill-opacity", .4)
}).catch(function(){ console.log("error")});


// Function that update circle position if something change
function update() {
  d3.selectAll("circle")
    .attr("cx", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).x })
    .attr("cy", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).y })
}

// If the user change the map (zoom or drag), I update circle position:
map.on("moveend", update)

</script>
</body>
</html>